<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Game Preview</title>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            width: 100%;
            height: 100vh;
        }

        body {
            overflow: hidden;
            background: #121419;
        }
        </style>
    </head>

    <body>
        <script type="module">
        import Hook from "console-feed/lib/Hook";

        Hook(window.console, hookConsole);
        window.addEventListener("error", e => console.error(e.message));

        const executeCode = (code) => {
            const previousScripts = document.querySelectorAll(
                "script[type=\"module\"]",
            );
            previousScripts.forEach(script => {
                script.remove();
            });

            try {
                const script = document.createElement("script");
                script.type = "module";
                script.textContent = code;
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error executing code:", error);
            }
        };

        window.addEventListener("message", (event) => {
            const { type, code } = event.data;

            if (type == "UPDATE_CODE") {
                console.groupCollapsed("[sandbox] Received code update");
                console.log("[sandbox] Code:", code);
                console.groupEnd();
                executeCode(code);
            } else if (type == "REFRESH") {
                console.log("[sandbox] Refreshing the page");
                document.location.href = document.location.href;
            } else if (type == "PAUSE") {
                const debug = window.debug ?? window._k_debug;
                if (!debug) return;
                console.log(
                    `[sandbox] ${debug.paused ? "Resuming" : "Pausing"} the game`,
                );
                debug.paused = !debug.paused;
            } else if (type == "FOCUS") {
                console.log("[sandbox] Focusing the game");
                document.querySelector("canvas")?.focus();
            }
        });

        window.addEventListener("load", () => {
            window.parent.postMessage({ type: "READY" }, "*");
        });

        const keysToPreventDefault = ["e", "p", "s"];

        window.addEventListener("keydown", (e) => {
            if (
                (e.key.length > 1 && e.key != "Escape")
                || !(e.ctrlKey || e.metaKey || e.altKey)
            ) return;

            if (
                e.target instanceof HTMLInputElement
                || e.target instanceof HTMLTextAreaElement
                || e.target?.isContentEditable
            ) return;

            if (keysToPreventDefault.includes(e.key.toLowerCase())) {
                e.preventDefault();
            }

            window.parent.postMessage({
                type: "KEY_BINDING",
                e: {
                    ctrlKey: e.ctrlKey,
                    metaKey: e.metaKey,
                    shiftKey: e.shiftKey,
                    altKey: e.altKey,
                    key: e.key,
                },
            }, "*");
        });

        function hookConsole(log) {
            window.parent.postMessage(
                {
                    type: "CONSOLE",
                    log: log,
                },
                "*",
            );
        }
        </script>
    </body>
</html>
