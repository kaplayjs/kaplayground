<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Game Preview</title>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            width: 100%;
            height: 100vh;
        }

        body {
            overflow: hidden;
            background: #121419;
        }
        </style>
    </head>

    <body>
        <script type="module">
        window.console = createConsoleProxy();
        window.addEventListener("error", e => console.error(e.message));

        const executeCode = (code) => {
            const previousScripts = document.querySelectorAll(
                "script[type=\"module\"]",
            );
            previousScripts.forEach(script => {
                script.remove();
            });

            try {
                const script = document.createElement("script");
                script.type = "module";
                script.textContent = code;
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error executing code:", error);
            }
        };

        window.addEventListener("message", (event) => {
            const { type, code } = event.data;

            if (type == "UPDATE_CODE") {
                console.groupCollapsed("[sandbox] Received code update");
                console.log("[sandbox] Code:", code);
                console.groupEnd();
                executeCode(code);
            } else if (type == "REFRESH") {
                console.log("[sandbox] Refreshing the page");
                document.location.href = document.location.href;
            } else if (type == "PAUSE") {
                const debug = window.debug ?? window._k_debug;
                if (!debug) return;
                console.log(
                    `[sandbox] ${debug.paused ? "Resuming" : "Pausing"} the game`,
                );
                debug.paused = !debug.paused;
            } else if (type == "FOCUS") {
                console.log("[sandbox] Focusing the game");
                document.querySelector("canvas")?.focus();
            }
        });

        window.addEventListener("load", () => {
            window.parent.postMessage({ type: "READY" }, "*");
        });

        const keysToPreventDefault = ["e", "p", "s"];

        window.addEventListener("keydown", (e) => {
            if (
                (e.key.length > 1 && e.key != "Escape")
                || !(e.ctrlKey || e.metaKey || e.altKey)
            ) return;

            if (
                e.target instanceof HTMLInputElement
                || e.target instanceof HTMLTextAreaElement
                || e.target?.isContentEditable
            ) return;

            if (keysToPreventDefault.includes(e.key.toLowerCase())) {
                e.preventDefault();
            }

            window.parent.postMessage({
                type: "KEY_BINDING",
                e: {
                    ctrlKey: e.ctrlKey,
                    metaKey: e.metaKey,
                    shiftKey: e.shiftKey,
                    altKey: e.altKey,
                    key: e.key,
                },
            }, "*");
        });

        function createConsoleProxy() {
            return new Proxy(console, {
                get(target, prop) {
                    if (typeof target[prop] !== "function") return target[prop];

                    return (...args) => {
                        try {
                            window.parent.postMessage(
                                {
                                    type: "CONSOLE",
                                    method: prop,
                                    messages: cloneLog(args),
                                },
                                "*",
                            );
                        } catch {
                            window.parent.postMessage(
                                {
                                    type: "CONSOLE",
                                    method: "warn",
                                    messages: [
                                        "Unsupported message (see browser console)",
                                    ],
                                },
                                "*",
                            );
                        }

                        target[prop](...args);
                    };
                },
            });
        }

        function cloneLog(value, circular = new WeakMap(), path = "root") {
            if (
                value === null
                || typeof value === "string"
                || typeof value === "number"
                || typeof value === "bigint"
                || typeof value === "boolean"
            ) {
                return value;
            }

            if (typeof value === "function") return "[Function]";

            if (value instanceof Error) return String(value);

            if (typeof value === "object") {
                if (circular.has(value)) return `[Circular: ${circular.get(value)}]`;
                circular.set(value, path);

                if (Array.isArray(value)) {
                    return value.map((v, i) =>
                        cloneLog(v, circular, `${path}${i > 0 ? `[${i}]` : ""}`)
                    );
                }

                const plainObj = {};
                for (const key of Object.keys(value)) {
                    try {
                        plainObj[key] = cloneLog(
                            value[key],
                            circular,
                            `${path}.${key}`,
                        );
                    } catch {
                        plainObj[key] = "[Unserializable]";
                    }
                }
                return plainObj;
            }

            return String(value);
        }
        </script>
    </body>
</html>
