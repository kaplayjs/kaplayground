<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Game Preview</title>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body,
        html {
            width: 100%;
            height: 100vh;
        }

        body {
            overflow: hidden;
            background: #121419;
        }
        </style>
    </head>

    <body>
        <script type="module">
        import Hook from "console-feed/lib/Hook";
        import Unhook from "console-feed/lib/Unhook";

        const params = new URLSearchParams(window.location.search);
        const isConsoleEnabled = (params.get("console") ?? "true") == "true";

        let hookedConsole = consoleHook(isConsoleEnabled);
        window.addEventListener("error", e => console.error(e.message));

        const executeCode = (code) => {
            const previousScripts = document.querySelectorAll(
                "script[type=\"module\"]",
            );
            previousScripts.forEach(script => script.remove());

            try {
                const script = document.createElement("script");
                script.type = "module";
                script.textContent = code;
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error executing code:", error.message);
            }
        };

        const messageEventHandlers = {
            UPDATE_CODE({ code }) {
                console.groupCollapsed("[sandbox] Received code update");
                console.log("[sandbox] Code:", code);
                console.groupEnd();

                if (document.visibilityState == "visible") {
                    executeCode(code);
                    return;
                }

                document.addEventListener("visibilitychange", function onChange() {
                    if (document.visibilityState != "visible") return;
                    document.removeEventListener("visibilitychange", onChange);
                    executeCode(code);
                });
            },

            REFRESH() {
                console.log("[sandbox] Refreshing the page");
                window.location.reload();
            },

            PAUSE() {
                const debug = window.debug ?? window._k_debug;
                if (!debug) return;
                console.log(
                    `[sandbox] ${debug.paused ? "Resuming" : "Pausing"} the game`,
                );
                debug.paused = !debug.paused;
            },

            FOCUS() {
                console.log("[sandbox] Focusing the game");
                document.querySelector("canvas")?.focus();
            },

            TOGGLE_CONSOLE({ enabled }) {
                if (enabled) {
                    console.log("[sandbox] Hooking the console");
                    hookedConsole.hook();
                } else {
                    console.log("[sandbox] Unhooking the console");
                    hookedConsole.unhook();
                }
            },
        };

        window.addEventListener("message", (event) => {
            messageEventHandlers[event.data?.type]?.(event.data);
        });

        window.addEventListener("load", () => {
            window.parent.postMessage({ type: "READY" }, "*");
        });

        const keysToPreventDefault = ["e", "p", "s"];

        window.addEventListener("keydown", (e) => {
            if (
                (e.key.length > 1 && e.key != "Escape")
                || !(e.ctrlKey || e.metaKey || e.altKey)
            ) return;

            if (
                e.target instanceof HTMLInputElement
                || e.target instanceof HTMLTextAreaElement
                || e.target?.isContentEditable
            ) return;

            if (keysToPreventDefault.includes(e.key.toLowerCase())) {
                e.preventDefault();
            }

            window.parent.postMessage({
                type: "KEY_BINDING",
                e: {
                    ctrlKey: e.ctrlKey,
                    metaKey: e.metaKey,
                    shiftKey: e.shiftKey,
                    altKey: e.altKey,
                    key: e.key,
                },
            }, "*");
        });

        function consoleHook(enabled) {
            let hooked = null;

            const hook = () => {
                hooked ??= Hook(
                    window.console,
                    log => window.parent.postMessage({ type: "CONSOLE", log }, "*"),
                );
            };

            const unhook = () => {
                if (!hooked) return;
                Unhook(hooked);
                hooked = null;
            };

            if (enabled) hook();

            return { hook, unhook };
        }
        </script>
    </body>
</html>
